# Maintainer: artist for XLibre

pkgname=xlibre-xf86-video-openchrome
_pkgname=xf86-video-openchrome
_commit=84093103eb50d29300251479820004dbb827dc18
pkgver=0.6.0.r811.g8409310
pkgrel=1
pkgdesc="XLibre fork of X.Org Openchrome drivers"
arch=(x86_64)
license=('custom')
url="https://github.com/X11Libre"
depends=('libdrm' 'libxvmc' 'systemd-libs')
makedepends=('xlibre-xserver-devel' 'X-ABI-VIDEODRV_VERSION=28.0'
             'git' 'systemd' 'libxv')
conflicts=('xorg-server<21.1.1' 'X-ABI-VIDEODRV_VERSION<28' 'X-ABI-VIDEODRV_VERSION>=29'
           ${_pkgname} 'xf86-video-via' 'xf86-video-unichrome' 'openchrome')
replaces=($_pkgname 'openchrome' 'xf86-video-via')
groups=('xlibre-drivers')
options=('!emptydirs')
source=("git+${url}/${_pkgname}.git#commit=$_commit"
        disable-xvmc-support.patch)

pkgver() {
  cd ${_pkgname}
  patch -Np1 -i ../disable-xvmc-support.patch
  git describe --long | sed 's/^xf86-video-openchrome-//;s/\([^-]*-g\)/r\1/;s/-/./g'
}

prepare() {
  cd ${_pkgname}
  patch -Np1 -i ../module-dir.patch
  cp $srcdir/xf86xvpriv.h src/   # is in the xlibre-xserver source but not in the package
  NOCONFIGURE=1 ./autogen.sh
}

build() {
  cd ${_pkgname}

  case "$CARCH" in
    "x86_64")
      CFLAGS=" -march=x86-64"
      ;;
    "aarch64")
      CFLAGS=" -march=armv8-a"
      ;;
    *)
      CFLAGS=" -march=native"
      ;;
  esac
  CFLAGS+=" -mtune=generic -O2 -pipe -fexceptions -Wp,-D_FORTIFY_SOURCE=3 -Wformat -Werror=format-security"
  CFLAGS+=" -fstack-clash-protection -fno-omit-frame-pointer -mno-omit-leaf-frame-pointer"
  LDFLAGS=" -Wl,-O1 -Wl,--sort-common -Wl,--as-needed -Wl,-z,lazy -Wl,-z,relro -Wl,-z,pack-relative-relocs"
  if [[ $CARCH != 'aarch64' ]]; then
    CFLAGS+=" -fcf-protection"
  fi
  # Since pacman 5.0.2-2, hardened flags are now enabled in makepkg.conf
  # With them, module fail to load with undefined symbol.
  # See https://bugs.archlinux.org/task/55102 / https://bugs.archlinux.org/task/54845
  if [[ "$pkgname" == *"xf86-input"* ]]; then
    CFLAGS+=" -fno-plt"
    LDFLAGS+=" -Wl,-z,now"
  fi
  if [[ "$pkgname" == *"xf86-video-intel"* ]]; then
    CFLAGS+=" -fno-lto"
    LDFLAGS+=" -fno-lto"
  fi
  CXXFLAGS="${CFLAGS} -Wp,-D_GLIBCXX_ASSERTIONS"
  export CFLAGS="${CFLAGS}"
  export CXXFLAGS="${CXXFLAGS}"
  export LDLAGS="${LDLAGS}"

  ./configure --prefix=/usr --enable-dri
  make
}

check() {
  cd ${_pkgname}
  make check
}

package() {
  cd ${_pkgname}
  make DESTDIR="${pkgdir}" install
  install -m755 -d "${pkgdir}/usr/share/licenses/${pkgname}"
  install -m644 COPYING "${pkgdir}/usr/share/licenses/${pkgname}/"
}

sha256sums=('fc55307520359adcb2d40a5f5de56a877ecdbaf5cc7a3a0abf23ead9805c66bd'
            'bfa92fa680b015471fd73534c1ef4f9e514c804f309d0d486de5759001546e4f')
